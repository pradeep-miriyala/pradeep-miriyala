<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mahabharata: Path of the Warrior</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto:wght@400;700&display=swap');
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #111827; /* gray-900 */
            overflow: hidden;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        .font-cinzel {
            font-family: 'Cinzel', serif;
        }

        /* Landscape enforcement */
        #orientation-lock {
            display: none;
        }
        @media (orientation: portrait) {
            #orientation-lock {
                display: flex;
            }
            #app-root {
                display: none;
            }
        }

        /* Custom scrollbar for leaderboard */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; 
        }

        /* Animations */
        @keyframes shine {
            0% { background-position: -100px; }
            40%, 100% { background-position: 200px; }
        }
        .card-shine {
            background: linear-gradient(to right, transparent 0%, rgba(255,255,255,0.2) 50%, transparent 100%);
            background-size: 200px 100%;
            background-repeat: no-repeat;
            animation: shine 3s infinite linear;
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.2); opacity: 0; }
        }
        .animate-pulse-ring {
            animation: pulse-ring 1s cubic-bezier(0, 0, 0.2, 1) infinite;
        }
    </style>
</head>
<body>
    <div id="orientation-lock" class="fixed inset-0 z-50 bg-black text-white flex-col items-center justify-center p-4 text-center">
        <div class="text-6xl mb-4">ðŸ”„</div>
        <h2 class="text-2xl font-bold font-cinzel text-yellow-500">Rotate Device</h2>
        <p class="mt-2 text-gray-400">Please rotate your device to landscape mode to play.</p>
    </div>

    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
        const { useState, useEffect, useRef, useLayoutEffect, useMemo, useCallback } = React;

        // --- Constants & Types ---
        const GAME_WIDTH = 1280;
        const GAME_HEIGHT = 720;
        const GRAVITY = 0.5;
        const GROUND_Y = GAME_HEIGHT - 100;

        const HEROES = {
            BHIMA: {
                name: 'Bhima',
                baseHp: 200,
                baseDef: 8,
                speed: 5,
                attackSpeed: 45, 
                projectileType: 'ROCK',
                color: '#ef4444', 
                emojis: ['ðŸ§”â€â™‚ï¸', 'ðŸ˜', 'ðŸŒªï¸'],
                description: 'Tank. Rage grows when hitting or hit. Special: Earth Shatter.',
                specialName: 'Earth Shatter',
                resourceType: 'RAGE',
                maxResource: 100,
                resourceColor: 'bg-red-600',
                specialCost: 60
            },
            ARJUNA: {
                name: 'Arjuna',
                baseHp: 120,
                baseDef: 3,
                speed: 9,
                attackSpeed: 25,
                projectileType: 'ARROW',
                color: '#3b82f6', 
                emojis: ['ðŸ‘¦', 'ðŸ¹', 'âœ¨'],
                description: 'Speed & Crit. Focus regens over time. Special: Astral Volley.',
                specialName: 'Astral Volley',
                resourceType: 'FOCUS',
                maxResource: 100,
                resourceColor: 'bg-blue-500',
                specialCost: 40
            }
        };

        const ENEMIES = [
            { type: 'IMP', hp: 20, damage: 5, speed: 3, score: 10, emoji: 'ðŸ‘º', scale: 40 },
            { type: 'DEMON', hp: 50, damage: 12, speed: 2, score: 30, emoji: 'ðŸ‘¹', scale: 60 },
            { type: 'KING', hp: 250, damage: 30, speed: 1.5, score: 100, emoji: 'ðŸ‘¿', scale: 100 },
            { type: 'ASURA', hp: 100, damage: 15, speed: 4, score: 50, emoji: 'ðŸ§Ÿ', scale: 50 }
        ];

        // --- Sound Manager (Web Audio API) ---
        const SoundManager = {
            ctx: null,
            init: () => {
                if (!SoundManager.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (AudioContext) SoundManager.ctx = new AudioContext();
                }
            },
            play: (type) => {
                if (!SoundManager.ctx) return;
                if (SoundManager.ctx.state === 'suspended') SoundManager.ctx.resume();
                
                const t = SoundManager.ctx.currentTime;
                const osc = SoundManager.ctx.createOscillator();
                const gain = SoundManager.ctx.createGain();
                
                osc.connect(gain);
                gain.connect(SoundManager.ctx.destination);

                switch (type) {
                    case 'ATTACK_BHIMA': // Heavy low thud
                        osc.type = 'square';
                        osc.frequency.setValueAtTime(120, t);
                        osc.frequency.exponentialRampToValueAtTime(40, t + 0.15);
                        gain.gain.setValueAtTime(0.3, t);
                        gain.gain.exponentialRampToValueAtTime(0.01, t + 0.15);
                        osc.start(t);
                        osc.stop(t + 0.2);
                        break;
                    case 'ATTACK_ARJUNA': // Fast zip
                        osc.type = 'triangle';
                        osc.frequency.setValueAtTime(600, t);
                        osc.frequency.linearRampToValueAtTime(300, t + 0.1);
                        gain.gain.setValueAtTime(0.15, t);
                        gain.gain.linearRampToValueAtTime(0.01, t + 0.1);
                        osc.start(t);
                        osc.stop(t + 0.1);
                        break;
                    case 'HIT': // Generic Impact
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(100, t);
                        osc.frequency.exponentialRampToValueAtTime(10, t + 0.1);
                        gain.gain.setValueAtTime(0.1, t);
                        gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
                        osc.start(t);
                        osc.stop(t + 0.1);
                        break;
                    case 'IMPACT': // Projectile hitting enemy (sharper)
                        osc.type = 'square';
                        osc.frequency.setValueAtTime(200, t);
                        osc.frequency.exponentialRampToValueAtTime(50, t + 0.05);
                        gain.gain.setValueAtTime(0.1, t);
                        gain.gain.exponentialRampToValueAtTime(0.01, t + 0.05);
                        osc.start(t);
                        osc.stop(t + 0.1);
                        break;
                    case 'SPECIAL': // Power up / Unleash
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(100, t);
                        osc.frequency.linearRampToValueAtTime(800, t + 0.5);
                        gain.gain.setValueAtTime(0.3, t);
                        gain.gain.linearRampToValueAtTime(0, t + 0.5);
                        osc.start(t);
                        osc.stop(t + 0.5);
                        break;
                    case 'SPAWN': // Low drone warning
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(50, t);
                        osc.frequency.linearRampToValueAtTime(80, t + 0.3);
                        gain.gain.setValueAtTime(0.05, t);
                        gain.gain.linearRampToValueAtTime(0, t + 0.3);
                        osc.start(t);
                        osc.stop(t + 0.3);
                        break;
                    case 'LEVELUP': // Major Arpeggio
                        [440, 554, 659, 880, 1108].forEach((freq, i) => {
                            const o = SoundManager.ctx.createOscillator();
                            const g = SoundManager.ctx.createGain();
                            o.connect(g);
                            g.connect(SoundManager.ctx.destination);
                            o.type = 'sine';
                            o.frequency.value = freq;
                            g.gain.setValueAtTime(0, t + i*0.08);
                            g.gain.linearRampToValueAtTime(0.1, t + i*0.08 + 0.05);
                            g.gain.exponentialRampToValueAtTime(0.01, t + i*0.08 + 0.5);
                            o.start(t + i*0.08);
                            o.stop(t + i*0.08 + 0.6);
                        });
                        break;
                }
            }
        };

        // --- Game Logic ---

        const App = () => {
            const [phase, setPhase] = useState('MENU'); // MENU, GAME, VICTORY, GAMEOVER
            const [selectedHero, setSelectedHero] = useState('BHIMA');
            const [hudState, setHudState] = useState({ 
                hp: 100, maxHp: 100, level: 1, score: 0, wave: 1, 
                resource: 0, maxResource: 100, resourceType: 'RAGE',
                exp: 0, nextExp: 100
            });
            const [highScores, setHighScores] = useState([]);
            
            useEffect(() => {
                const savedScores = localStorage.getItem('mahabharata_scores');
                if (savedScores) {
                    setHighScores(JSON.parse(savedScores));
                }
                
                const initAudio = () => SoundManager.init();
                window.addEventListener('click', initAudio, { once: true });
                window.addEventListener('touchstart', initAudio, { once: true });
                window.addEventListener('keydown', initAudio, { once: true });
                return () => {
                    window.removeEventListener('click', initAudio);
                    window.removeEventListener('touchstart', initAudio);
                    window.removeEventListener('keydown', initAudio);
                };
            }, []);

            const saveScore = (score, hero) => {
                const newScores = [...highScores, { score, hero, date: new Date().toLocaleDateString() }]
                    .sort((a, b) => b.score - a.score)
                    .slice(10);
                setHighScores(newScores);
                localStorage.setItem('mahabharata_scores', JSON.stringify(newScores));
            };

            const toggleFullscreen = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(e => console.log(e));
                } else if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            };

            return (
                <div className="w-full h-screen bg-gray-900 overflow-hidden relative select-none">
                    {phase === 'MENU' && (
                        <MenuScreen 
                            onStart={() => { SoundManager.init(); setPhase('GAME'); }} 
                            selectedHero={selectedHero} 
                            setSelectedHero={setSelectedHero}
                            highScores={highScores}
                            toggleFullscreen={toggleFullscreen}
                        />
                    )}

                    {phase === 'GAME' && (
                        <GameCanvas 
                            heroType={selectedHero}
                            onGameOver={(score) => {
                                saveScore(score, selectedHero);
                                setPhase('GAMEOVER');
                            }}
                            onVictory={(score) => {
                                saveScore(score, selectedHero);
                                setPhase('VICTORY');
                            }}
                            setHudState={setHudState}
                            onExit={() => setPhase('MENU')}
                        />
                    )}

                    {phase === 'GAME' && (
                        <HUD 
                            state={hudState} 
                            heroType={selectedHero} 
                            onExit={() => setPhase('MENU')}
                        />
                    )}

                    {(phase === 'VICTORY' || phase === 'GAMEOVER') && (
                        <EndScreen 
                            phase={phase} 
                            score={hudState.score} 
                            hero={selectedHero} 
                            onRestart={() => setPhase('MENU')} 
                        />
                    )}
                </div>
            );
        };

        // --- Components ---

        const MenuScreen = ({ onStart, selectedHero, setSelectedHero, highScores, toggleFullscreen }) => {
            const heroData = HEROES[selectedHero];

            return (
                <div className="absolute inset-0 overflow-y-auto flex flex-col items-center justify-start md:justify-center bg-[url('https://images.unsplash.com/photo-1599592186847-f25b12852656?q=80&w=1920')] bg-cover bg-center">
                    <div className="fixed inset-0 bg-black/70 backdrop-blur-sm -z-10"></div>
                    
                    <div className="z-10 text-center w-full p-4 flex flex-col md:flex-row gap-8 items-center justify-center min-h-screen md:min-h-0">
                        {/* Left: Hero Selection */}
                        <div className="flex-1 flex flex-col items-center space-y-4 md:space-y-6 max-w-lg w-full pt-10 md:pt-0">
                            <div>
                                <h1 className="text-3xl md:text-6xl font-bold font-cinzel text-yellow-500 mb-1 md:mb-2 tracking-wider shadow-black drop-shadow-lg">
                                    MAHABHARATA
                                </h1>
                                <p className="text-sm md:text-xl text-gray-300 font-cinzel mb-4 md:mb-8">Path of the Warrior</p>
                            </div>
                            
                            <div className="flex gap-4 mb-2">
                                {Object.keys(HEROES).map(key => (
                                    <button
                                        key={key}
                                        onClick={() => setSelectedHero(key)}
                                        className={`px-4 py-2 md:px-6 md:py-3 rounded-lg font-bold border-2 transition-all transform hover:scale-105 text-sm md:text-base ${
                                            selectedHero === key 
                                            ? 'bg-yellow-600 border-yellow-400 text-white shadow-[0_0_20px_rgba(234,179,8,0.5)]' 
                                            : 'bg-gray-800 border-gray-600 text-gray-400 hover:bg-gray-700'
                                        }`}
                                    >
                                        {key}
                                    </button>
                                ))}
                            </div>

                            <div className="bg-gray-800/80 p-4 md:p-6 rounded-xl border border-gray-600 w-full max-w-md card-shine">
                                <div className="text-4xl md:text-6xl mb-2 md:mb-4 animate-bounce">{heroData.emojis[0]}</div>
                                <h2 className="text-xl md:text-2xl font-bold text-yellow-400 mb-1">{heroData.name}</h2>
                                <p className="text-gray-300 text-xs md:text-sm mb-3">{heroData.description}</p>
                                <div className="grid grid-cols-2 gap-2 text-xs md:text-sm">
                                    <div className="flex justify-between"><span>HP:</span> <span className="text-green-400">{'|'.repeat(heroData.baseHp/20)}</span></div>
                                    <div className="flex justify-between"><span>SPD:</span> <span className="text-blue-400">{'|'.repeat(heroData.speed)}</span></div>
                                    <div className="flex justify-between"><span>DEF:</span> <span className="text-gray-400">{'|'.repeat(heroData.baseDef)}</span></div>
                                </div>
                                <div className="mt-3 pt-3 border-t border-gray-700 text-[10px] md:text-xs">
                                    <span className="text-yellow-200 font-bold">SPECIAL: {heroData.specialName}</span>
                                    <div className="text-gray-400 mt-1">Cost: {heroData.specialCost} {heroData.resourceType}</div>
                                </div>
                            </div>

                            <div className="flex flex-col gap-2 w-full max-w-md pb-10 md:pb-0">
                                <button 
                                    onClick={onStart}
                                    className="w-full px-8 py-3 md:py-4 bg-red-600 hover:bg-red-500 text-white text-lg md:text-xl font-bold rounded-full shadow-[0_0_30px_rgba(220,38,38,0.6)] transform transition hover:scale-105 active:scale-95"
                                >
                                    ENTER BATTLE
                                </button>
                                <button onClick={toggleFullscreen} className="text-xs md:text-sm text-gray-400 underline p-2">
                                    Toggle Fullscreen
                                </button>
                            </div>
                        </div>

                        {/* Right: Leaderboard (Hidden on small mobile landscape) */}
                        <div className="hidden md:block w-80 bg-gray-900/90 rounded-lg border border-gray-700 p-4 h-96 overflow-hidden flex flex-col">
                            <h3 className="text-xl font-cinzel text-yellow-500 border-b border-gray-700 pb-2 mb-2 text-center">Hall of Heroes</h3>
                            <div className="overflow-y-auto flex-1 space-y-2">
                                {highScores.length === 0 ? (
                                    <div className="text-gray-500 text-center mt-10">No Legends Yet</div>
                                ) : (
                                    highScores.map((s, i) => (
                                        <div key={i} className="flex justify-between items-center text-sm p-2 bg-gray-800/50 rounded">
                                            <span className="text-yellow-500 w-6">#{i+1}</span>
                                            <span className="flex-1 text-gray-300 text-left pl-2">{s.hero}</span>
                                            <span className="font-mono font-bold text-white">{s.score}</span>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const HUD = ({ state, heroType, onExit }) => {
            const heroConfig = HEROES[heroType];
            const hpPercent = Math.max(0, (state.hp / state.maxHp) * 100);
            const resPercent = Math.max(0, (state.resource / state.maxResource) * 100);
            const expPercent = Math.max(0, (state.exp / state.nextExp) * 100);
            
            return (
                <div className="absolute top-0 left-0 w-full p-2 md:p-4 flex justify-between items-start pointer-events-none z-20">
                    <div className="flex flex-col gap-1 md:gap-2 w-56 md:w-72">
                        {/* HP Bar */}
                        <div className="w-full h-5 md:h-6 bg-gray-900 border-2 border-gray-600 rounded-full relative overflow-hidden">
                            <div 
                                className="h-full bg-gradient-to-r from-red-600 to-red-400 transition-all duration-300 ease-out"
                                style={{ width: `${hpPercent}%` }}
                            ></div>
                            <span className="absolute inset-0 flex items-center justify-center text-[10px] md:text-xs font-bold text-white drop-shadow-md">
                                {state.hp} / {state.maxHp} HP
                            </span>
                        </div>
                        
                        {/* XP Bar */}
                        <div className="w-full h-1.5 bg-gray-900 rounded-full relative overflow-hidden">
                             <div 
                                className="h-full bg-yellow-400 transition-all duration-300 ease-out shadow-[0_0_10px_rgba(250,204,21,0.8)]"
                                style={{ width: `${expPercent}%` }}
                            ></div>
                        </div>

                        {/* Resource Bar */}
                        <div className="w-3/4 h-3 md:h-4 bg-gray-900 border border-gray-600 rounded-full relative overflow-hidden shadow-[0_0_10px_rgba(0,0,0,0.5)]">
                             <div 
                                className={`h-full ${heroConfig.resourceColor} transition-all duration-300 ease-out`}
                                style={{ width: `${resPercent}%` }}
                            ></div>
                             <span className="absolute inset-0 flex items-center justify-center text-[8px] md:text-[10px] font-bold text-white drop-shadow-md">
                                {Math.floor(state.resource)} {state.resourceType}
                            </span>
                        </div>

                        <div className="flex gap-2">
                            <span className="bg-blue-900/80 px-2 py-1 rounded text-xs text-blue-200 border border-blue-500 font-bold">
                                LVL {state.level}
                            </span>
                             <span className="bg-purple-900/80 px-2 py-1 rounded text-xs text-purple-200 border border-purple-500 font-bold">
                                WAVE {state.wave}
                            </span>
                        </div>
                    </div>
                    
                    <div className="flex items-start gap-4">
                        <div className="text-right">
                            <div className="text-2xl md:text-3xl font-cinzel text-yellow-400 drop-shadow-lg font-bold">
                                {state.score.toLocaleString()}
                            </div>
                            <div className="text-[10px] md:text-xs text-gray-400 uppercase tracking-widest">Score</div>
                        </div>
                        <button 
                            onClick={onExit}
                            className="pointer-events-auto bg-red-900/80 hover:bg-red-700 text-red-100 px-3 py-1 rounded border border-red-500 text-xs font-bold transition-colors"
                        >
                            HOME
                        </button>
                    </div>
                </div>
            );
        };

        const EndScreen = ({ phase, score, hero, onRestart }) => {
            const isVictory = phase === 'VICTORY';
            return (
                <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md">
                    <div className={`text-center p-8 rounded-2xl border-4 max-w-lg w-full transform transition-all scale-100 ${isVictory ? 'border-yellow-500 bg-yellow-900/20' : 'border-red-800 bg-red-900/20'}`}>
                        <div className="text-8xl mb-6 animate-pulse">
                            {isVictory ? 'ðŸ‘‘' : 'ðŸ’€'}
                        </div>
                        <h2 className={`text-5xl font-cinzel font-bold mb-2 ${isVictory ? 'text-yellow-400' : 'text-red-500'}`}>
                            {isVictory ? 'VICTORY' : 'DEFEATED'}
                        </h2>
                        <p className="text-gray-300 mb-8 font-cinzel">
                            {isVictory ? 'The demons have been vanquished.' : 'Your journey ends here, warrior.'}
                        </p>
                        
                        <div className="bg-gray-800/50 p-6 rounded-lg mb-8 border border-gray-700">
                            <p className="text-gray-400 uppercase text-xs tracking-widest mb-1">Final Score</p>
                            <p className="text-4xl font-mono font-bold text-white">{score.toLocaleString()}</p>
                            <p className="text-sm text-gray-500 mt-2">Hero: <span className="text-gray-300">{HEROES[hero].name}</span></p>
                        </div>

                        <button 
                            onClick={onRestart}
                            className={`px-10 py-3 rounded-full font-bold text-xl transition-transform hover:scale-105 ${isVictory ? 'bg-yellow-600 hover:bg-yellow-500 text-black' : 'bg-gray-700 hover:bg-gray-600 text-white'}`}
                        >
                            {isVictory ? 'Play Again' : 'Menu'}
                        </button>
                    </div>
                </div>
            );
        };

        // --- Game Engine Wrapper ---

        const GameCanvas = ({ heroType, onGameOver, onVictory, setHudState, onExit }) => {
            const canvasRef = useRef(null);
            const requestRef = useRef();
            const inputRef = useRef({ left: false, right: false, up: false, down: false, attack: false, special: false });
            
            // Game State Ref (Mutable for performance)
            const gameRef = useRef({
                hero: null,
                enemies: [],
                projectiles: [],
                particles: [],
                texts: [],
                effects: [], // Shockwaves etc
                score: 0,
                wave: 1,
                lastTime: 0,
                spawnTimer: 0,
                gameTime: 0,
                cameraX: 0,
                specialCooldown: 0
            });

            // Input Handlers
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.code === 'ArrowLeft') inputRef.current.left = true;
                    if (e.code === 'ArrowRight') inputRef.current.right = true;
                    if (e.code === 'ArrowUp') inputRef.current.up = true;
                    if (e.code === 'ArrowDown') inputRef.current.down = true;
                    if (e.code === 'Space') inputRef.current.attack = true;
                    if (e.code === 'ShiftLeft' || e.code === 'ShiftRight' || e.key === 'z' || e.key === 'Z') inputRef.current.special = true;
                    if (e.code === 'Escape') onExit();
                };
                const handleKeyUp = (e) => {
                    if (e.code === 'ArrowLeft') inputRef.current.left = false;
                    if (e.code === 'ArrowRight') inputRef.current.right = false;
                    if (e.code === 'ArrowUp') inputRef.current.up = false;
                    if (e.code === 'ArrowDown') inputRef.current.down = false;
                    if (e.code === 'Space') inputRef.current.attack = false;
                    if (e.code === 'ShiftLeft' || e.code === 'ShiftRight' || e.key === 'z' || e.key === 'Z') inputRef.current.special = false;
                };
                window.addEventListener('keydown', handleKeyDown);
                window.addEventListener('keyup', handleKeyUp);
                return () => {
                    window.removeEventListener('keydown', handleKeyDown);
                    window.removeEventListener('keyup', handleKeyUp);
                };
            }, [onExit]);

            // Initialization
            useEffect(() => {
                const heroConfig = HEROES[heroType];
                gameRef.current = {
                    ...gameRef.current,
                    hero: {
                        x: 100,
                        y: GROUND_Y,
                        vx: 0,
                        vy: 0,
                        hp: heroConfig.baseHp,
                        maxHp: heroConfig.baseHp,
                        level: 1,
                        exp: 0,
                        attackCooldown: 0,
                        config: heroConfig,
                        resource: heroType === 'ARJUNA' ? 50 : 0 // Arjuna starts with some Focus
                    },
                    enemies: [],
                    projectiles: [],
                    particles: [],
                    texts: [],
                    effects: [],
                    score: 0,
                    wave: 1,
                    lastTime: performance.now(),
                    specialCooldown: 0
                };
            }, [heroType]);

            // Helper: Create Particle
            const spawnParticles = (x, y, color, count = 5, type = 'CIRCLE') => {
                for (let i = 0; i < count; i++) {
                    gameRef.current.particles.push({
                        x, y,
                        vx: (Math.random() - 0.5) * 10,
                        vy: (Math.random() - 0.5) * 10,
                        life: 1.0,
                        color,
                        type
                    });
                }
            };

            // Helper: Floating Text
            const showDamage = (x, y, amount, isCrit = false) => {
                gameRef.current.texts.push({
                    x, y,
                    text: amount.toString(),
                    life: 1.0,
                    color: isCrit ? '#fbbf24' : '#ffffff',
                    scale: isCrit ? 40 : 20,
                    vy: -2
                });
            };

            // Main Loop
            const update = useCallback((time) => {
                const state = gameRef.current;
                const dt = Math.min((time - state.lastTime) / 16.67, 2); // Cap dt
                state.lastTime = time;
                state.gameTime += dt;

                const ctx = canvasRef.current.getContext('2d');
                const { hero } = state;
                const { config } = hero;
                const nextLevelExp = 50 * hero.level; // Reduced XP curve

                // --- UPDATE ---

                // Resource Regeneration (Arjuna Focus - Passive)
                if (config.name === 'ARJUNA') {
                    hero.resource = Math.min(config.maxResource, hero.resource + 0.2 * dt); // 12 resource/sec roughly
                }

                // Hero Movement
                const input = inputRef.current;
                if (input.left) hero.vx = -config.speed;
                else if (input.right) hero.vx = config.speed;
                else hero.vx = 0;

                if (input.up) hero.vy = -config.speed * 0.7; 
                else if (input.down) hero.vy = config.speed * 0.7;
                else hero.vy = 0;

                hero.x += hero.vx * dt;
                hero.y += hero.vy * dt;

                // Boundaries
                hero.x = Math.max(50, Math.min(hero.x, GAME_WIDTH - 50));
                hero.y = Math.max(GAME_HEIGHT/2, Math.min(hero.y, GAME_HEIGHT - 50));
                
                // Hero Attack
                if (hero.attackCooldown > 0) hero.attackCooldown -= dt;
                if (input.attack && hero.attackCooldown <= 0) {
                    hero.attackCooldown = config.attackSpeed - (hero.level * 2);
                    SoundManager.play(`ATTACK_${config.name.toUpperCase()}`);
                    
                    const pConfig = {
                        x: hero.x + 30, 
                        y: hero.y - 10,
                        vx: 15, // Strict Right Direction
                        vy: 0,
                        life: 80,
                        damage: 10 + (hero.level * 2),
                        rotation: 0,
                        type: config.projectileType,
                        owner: 'HERO'
                    };

                    if (config.projectileType === 'ROCK') {
                        pConfig.vy = -4; // Slight Arc
                    }
                    
                    state.projectiles.push(pConfig);
                    
                    // Bhima builds Rage on swing (Aggressive)
                    if (config.name === 'BHIMA') {
                        hero.resource = Math.min(config.maxResource, hero.resource + 3);
                    }
                }

                // Special Ability Logic
                if (state.specialCooldown > 0) state.specialCooldown -= dt;
                if (input.special && state.specialCooldown <= 0) {
                    if (hero.resource >= config.specialCost) {
                        // Activate Special
                        hero.resource -= config.specialCost;
                        state.specialCooldown = 60; 
                        SoundManager.play('SPECIAL');

                        if (config.name === 'BHIMA') {
                            // EARTH SHATTER: Big Shockwave, Knockback, Stun
                            state.effects.push({
                                type: 'SHOCKWAVE',
                                x: hero.x + 50,
                                y: hero.y,
                                radius: 10,
                                maxRadius: 300,
                                alpha: 1,
                                color: '#a16207'
                            });
                            
                            // Logic hit
                            state.enemies.forEach(e => {
                                const dist = Math.abs(e.x - hero.x);
                                if (dist < 400 && e.x > hero.x) {
                                    e.hp -= 50 + (hero.level * 10);
                                    e.x += 250; // Massive Knockback
                                    e.frozen = 60; // Stun 1s
                                    showDamage(e.x, e.y, "SMASH!", true);
                                    spawnParticles(e.x, e.y, '#a16207', 10);
                                }
                            });
                            // Shake
                            state.screenShake = 20;
                        } else if (config.name === 'ARJUNA') {
                            // ASTRAL VOLLEY: Rapid Fire Homing-ish arrows
                            for(let i=0; i<7; i++) {
                                setTimeout(() => {
                                    state.projectiles.push({
                                        x: hero.x + 30,
                                        y: hero.y - 40 + (Math.random()*40),
                                        vx: 25, // Very fast
                                        vy: (Math.random() - 0.5) * 2,
                                        life: 100,
                                        damage: 20 + (hero.level * 3),
                                        rotation: 0,
                                        type: 'ARROW',
                                        owner: 'HERO',
                                        isSpecial: true,
                                        piercing: true // Arrows go through enemies
                                    });
                                    SoundManager.play('ATTACK_ARJUNA'); // Pew pew pew
                                }, i * 50); // Staggered launch
                            }
                        }
                    }
                }

                // Spawning Enemies
                state.spawnTimer += dt;
                const spawnRate = Math.max(40, 180 - (state.wave * 10)); 
                if (state.spawnTimer > spawnRate) {
                    state.spawnTimer = 0;
                    SoundManager.play('SPAWN');
                    const enemyPool = ENEMIES.filter((_, i) => i <= Math.min(ENEMIES.length-1, Math.floor(state.wave / 2)));
                    const chosen = enemyPool[Math.floor(Math.random() * enemyPool.length)];

                    state.enemies.push({
                        ...chosen,
                        x: GAME_WIDTH + 100,
                        y: (GAME_HEIGHT/2) + Math.random() * (GAME_HEIGHT/2 - 50),
                        maxHp: chosen.hp + (state.wave * 10),
                        hp: chosen.hp + (state.wave * 10),
                        frozen: 0
                    });
                }

                // Update Projectiles
                state.projectiles.forEach(p => {
                    p.x += p.vx * dt;
                    p.y += p.vy * dt;
                    if (p.type === 'ROCK') p.vy += 0.2 * dt; // Gravity
                    p.rotation = Math.atan2(p.vy, p.vx);
                    p.life -= dt;
                    if (p.isSpecial) spawnParticles(p.x, p.y, '#60a5fa', 1);
                });
                state.projectiles = state.projectiles.filter(p => p.life > 0 && p.x > -100 && p.x < GAME_WIDTH + 100 && p.y < GAME_HEIGHT);

                // Update Enemies
                state.enemies.forEach(e => {
                    if (e.frozen > 0) {
                        e.frozen -= dt;
                        return;
                    }
                    e.x -= e.speed * dt;
                });

                // Collisions: Projectile vs Enemy
                state.projectiles.forEach(p => {
                    if (p.owner !== 'HERO') return;
                    // Filter out dead projectiles already processed if not piercing
                    if (p.dead) return;

                    state.enemies.forEach(e => {
                        if (p.dead && !p.piercing) return;
                        
                        const dx = p.x - e.x;
                        const dy = p.y - e.y;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        if (dist < (e.scale/2 + 20)) {
                            // Hit
                            SoundManager.play('IMPACT');
                            const isCrit = config.name === 'Arjuna' && Math.random() < 0.35;
                            const dmg = isCrit ? p.damage * 2 : p.damage;
                            e.hp -= dmg;
                            
                            if (!p.piercing) p.dead = true; // Mark for deletion

                            showDamage(e.x, e.y - 50, Math.floor(dmg), isCrit);
                            spawnParticles(e.x, e.y, '#ef4444', 5);
                            
                            // Knockback small enemies
                            if (e.type === 'IMP') e.x += 10;

                            // Resource gain on hit (Bhima)
                             if (config.name === 'BHIMA') {
                                hero.resource = Math.min(config.maxResource, hero.resource + 5);
                            }
                        }
                    });
                });
                state.projectiles = state.projectiles.filter(p => !p.dead);

                // Collisions: Enemy vs Player
                state.enemies.forEach(e => {
                    const dx = e.x - hero.x;
                    const dy = e.y - hero.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < 50) { // Contact damage
                         const def = config.baseDef + hero.level;
                         const dmg = Math.max(1, e.damage - def);
                         
                         hero.hp -= dmg * 0.1 * dt; 
                         if (Math.random() < 0.1) {
                             spawnParticles(hero.x, hero.y, '#ffffff', 2);
                             SoundManager.play('HIT');
                             if(config.name === 'BHIMA') hero.resource = Math.min(config.maxResource, hero.resource + 5); // Rage on hit
                         }
                    }
                });

                // Death Logic
                if (hero.hp <= 0) {
                    onGameOver(Math.floor(state.score));
                    return; 
                }

                // Cleanup Enemies & XP
                const initialCount = state.enemies.length;
                state.enemies = state.enemies.filter(e => {
                    if (e.hp <= 0) {
                        state.score += e.score;
                        hero.exp += 20;
                        spawnParticles(e.x, e.y, '#fbbf24', 15);
                        return false;
                    }
                    if (e.x < -100) return false; 
                    return true;
                });
                
                if (initialCount > state.enemies.length) {
                    // Level Up Check
                    if (hero.exp >= nextLevelExp) {
                        hero.exp -= nextLevelExp;
                        hero.level++;
                        hero.hp = Math.min(hero.hp + 50, config.baseHp + (hero.level * 20));
                        hero.maxHp = config.baseHp + (hero.level * 20);
                        showDamage(hero.x, hero.y - 80, "LEVEL UP!", true);
                        SoundManager.play('LEVELUP');
                    }
                    // Wave Logic - Faster waves
                    const waveThreshold = state.wave * 250; // Reduced from 500
                    if (state.score > waveThreshold && state.score - (initialCount - state.enemies.length) * 10 <= waveThreshold) {
                         // Just crossed threshold? (Logic slightly fuzzy here due to score jumps, checking simple condition)
                         // We use a persistent flag in a real engine, here we just check if we are high enough and it feels like a new wave
                    }
                }
                // Wave progression check
                const targetScore = state.wave * 250;
                if (state.score > targetScore) {
                     state.wave++;
                     showDamage(GAME_WIDTH/2, GAME_HEIGHT/2, `WAVE ${state.wave}`, true);
                }


                // Update Particles
                state.particles.forEach(p => {
                    p.x += p.vx * dt;
                    p.y += p.vy * dt;
                    p.life -= 0.05 * dt;
                });
                state.particles = state.particles.filter(p => p.life > 0);

                // Update Effects (Shockwaves)
                state.effects.forEach(eff => {
                    if (eff.type === 'SHOCKWAVE') {
                        eff.radius += 15 * dt;
                        eff.alpha -= 0.05 * dt;
                    }
                });
                state.effects = state.effects.filter(eff => eff.alpha > 0);

                // Update Text
                state.texts.forEach(t => {
                    t.y += t.vy * dt;
                    t.life -= 0.02 * dt;
                });
                state.texts = state.texts.filter(t => t.life > 0);

                setHudState({
                    hp: Math.floor(hero.hp),
                    maxHp: Math.floor(hero.maxHp),
                    level: hero.level,
                    score: Math.floor(state.score),
                    wave: state.wave,
                    resource: hero.resource,
                    maxResource: config.maxResource,
                    resourceType: config.resourceType,
                    exp: hero.exp,
                    nextExp: nextLevelExp
                });

                // --- RENDER ---
                ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
                
                // Screen Shake
                ctx.save();
                if (state.screenShake > 0) {
                    const shake = state.screenShake;
                    ctx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake);
                    state.screenShake -= dt;
                }

                // Background
                ctx.fillStyle = '#111827';
                ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

                // Parallax Background
                const scroll = state.gameTime * 2;
                // Mountains
                ctx.fillStyle = '#1f2937';
                for(let i=0; i<10; i++) {
                    ctx.beginPath();
                    ctx.moveTo((i*300) - (scroll*0.5 % 300), GAME_HEIGHT);
                    ctx.lineTo((i*300) + 150 - (scroll*0.5 % 300), GAME_HEIGHT - 300);
                    ctx.lineTo((i*300) + 300 - (scroll*0.5 % 300), GAME_HEIGHT);
                    ctx.fill();
                }
                // Ground
                ctx.fillStyle = '#374151';
                ctx.fillRect(0, GROUND_Y + 50, GAME_WIDTH, 100);

                // Draw Effects (Behind chars)
                state.effects.forEach(eff => {
                    if (eff.type === 'SHOCKWAVE') {
                        ctx.beginPath();
                        ctx.arc(eff.x, eff.y, eff.radius, 0, Math.PI * 2);
                        ctx.strokeStyle = eff.color;
                        ctx.lineWidth = 5;
                        ctx.globalAlpha = eff.alpha;
                        ctx.stroke();
                        ctx.globalAlpha = 1;
                    }
                });

                // Draw Hero
                // We REMOVED the horizontal flip. Hero always faces RIGHT.
                const heroEmoji = config.emojis[Math.min(2, Math.floor((hero.level - 1) / 5))];
                ctx.font = '80px Serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                ctx.save();
                ctx.translate(hero.x, hero.y);
                // Only tilt for movement speed impression
                ctx.rotate(hero.vx * 0.02); 
                ctx.fillText(heroEmoji, 0, 0);
                
                if (config.baseDef + hero.level > 10) {
                    ctx.font = '30px Serif';
                    ctx.fillText('ðŸ›¡ï¸', 30, -30);
                }
                ctx.restore();

                // Draw Enemies
                state.enemies.forEach(e => {
                    ctx.font = `${e.scale}px Serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(e.emoji, e.x, e.y);
                    
                    // HP Bar
                    const w = 50;
                    ctx.fillStyle = 'red';
                    ctx.fillRect(e.x - w/2, e.y - e.scale/2 - 10, w * (e.hp / e.maxHp), 5);
                });

                // Draw Projectiles
                state.projectiles.forEach(p => {
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rotation);
                    ctx.fillStyle = p.isSpecial ? '#60a5fa' : config.color;
                    
                    if (p.isSpecial && config.name === 'ARJUNA') {
                        // Glowing Arrow
                        ctx.shadowColor = '#3b82f6';
                        ctx.shadowBlur = 10;
                    }

                    if (p.type === 'ROCK') {
                        ctx.beginPath();
                        ctx.arc(0, 0, 10, 0, Math.PI*2);
                        ctx.fill();
                    } else {
                        // Arrow shape
                        ctx.beginPath();
                        ctx.moveTo(-10, -3);
                        ctx.lineTo(10, 0);
                        ctx.lineTo(-10, 3);
                        ctx.fill();
                    }
                    ctx.shadowBlur = 0;
                    ctx.restore();
                });

                // Draw Particles
                state.particles.forEach(p => {
                    ctx.globalAlpha = p.life;
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 5, 0, Math.PI*2);
                    ctx.fill();
                    ctx.globalAlpha = 1.0;
                });

                // Draw Text
                state.texts.forEach(t => {
                    ctx.globalAlpha = t.life;
                    ctx.font = `bold ${t.scale}px sans-serif`;
                    ctx.fillStyle = t.color;
                    ctx.strokeStyle = 'black';
                    ctx.lineWidth = 2;
                    ctx.strokeText(t.text, t.x, t.y);
                    ctx.fillText(t.text, t.x, t.y);
                    ctx.globalAlpha = 1.0;
                });
                
                ctx.restore(); // Restore shake state

                requestRef.current = requestAnimationFrame(() => update(performance.now()));
            }, [heroType, onGameOver]);

            useLayoutEffect(() => {
                const resize = () => {
                    const canvas = canvasRef.current;
                    if(!canvas) return;
                    const scale = Math.min(window.innerWidth / GAME_WIDTH, window.innerHeight / GAME_HEIGHT);
                    canvas.style.width = `${GAME_WIDTH * scale}px`;
                    canvas.style.height = `${GAME_HEIGHT * scale}px`;
                };
                window.addEventListener('resize', resize);
                resize();
                
                requestRef.current = requestAnimationFrame(() => update(performance.now()));

                return () => {
                    window.removeEventListener('resize', resize);
                    cancelAnimationFrame(requestRef.current);
                }
            }, [update]);

            const handleTouchStart = (key) => (e) => { e.preventDefault(); inputRef.current[key] = true; };
            const handleTouchEnd = (key) => (e) => { e.preventDefault(); inputRef.current[key] = false; };

            return (
                <div className="w-full h-full flex items-center justify-center bg-black relative">
                    <canvas 
                        ref={canvasRef} 
                        width={GAME_WIDTH} 
                        height={GAME_HEIGHT} 
                        className="bg-gray-900 shadow-2xl"
                    />

                    {/* Mobile Controls Overlay */}
                    <div className="absolute inset-0 pointer-events-none flex flex-col justify-end pb-8 px-8 md:hidden">
                        <div className="flex justify-between items-end pointer-events-auto">
                            {/* D-Pad */}
                            <div className="relative w-40 h-40">
                                <div className="absolute top-0 left-1/3 w-1/3 h-1/3 bg-white/20 rounded-t-lg active:bg-white/40"
                                    onTouchStart={handleTouchStart('up')} onTouchEnd={handleTouchEnd('up')}></div>
                                <div className="absolute bottom-0 left-1/3 w-1/3 h-1/3 bg-white/20 rounded-b-lg active:bg-white/40"
                                    onTouchStart={handleTouchStart('down')} onTouchEnd={handleTouchEnd('down')}></div>
                                <div className="absolute top-1/3 left-0 w-1/3 h-1/3 bg-white/20 rounded-l-lg active:bg-white/40"
                                    onTouchStart={handleTouchStart('left')} onTouchEnd={handleTouchEnd('left')}></div>
                                <div className="absolute top-1/3 right-0 w-1/3 h-1/3 bg-white/20 rounded-r-lg active:bg-white/40"
                                    onTouchStart={handleTouchStart('right')} onTouchEnd={handleTouchEnd('right')}></div>
                                <div className="absolute top-1/3 left-1/3 w-1/3 h-1/3 bg-black/50 rounded-full"></div>
                            </div>

                            {/* Action Buttons */}
                            <div className="flex gap-4 items-end">
                                <button 
                                    className="w-16 h-16 bg-yellow-600/50 rounded-full border-4 border-yellow-400 active:bg-yellow-600 active:scale-95 transition-transform flex items-center justify-center"
                                    onTouchStart={handleTouchStart('special')} onTouchEnd={handleTouchEnd('special')}
                                >
                                    <span className="text-xl">âš¡</span>
                                </button>
                                <button 
                                    className="w-24 h-24 bg-red-600/50 rounded-full border-4 border-red-400 active:bg-red-600 active:scale-95 transition-transform flex items-center justify-center"
                                    onTouchStart={handleTouchStart('attack')} onTouchEnd={handleTouchEnd('attack')}
                                >
                                    <span className="text-3xl">âš”ï¸</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
